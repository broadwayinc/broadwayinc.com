<!DOCTYPE html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-init-css@latest/init.css">
<link rel="stylesheet" href="../style.css">

<script src="https://cdn.jsdelivr.net/npm/skapi-js@beta/dist/skapi.js"></script>
<script>
    const skapi = new Skapi("ap212Oua4WPuUkTTxckv", "4d4a36a5-b318-4093-92ae-7cf11feae989", {autoLogin: true}, {"hostDomain": "skapi.app", "target_cdn": "d1wrj5ymxrt2ir"});
</script>

<div style="display: flex; align-items: center; justify-content: space-between;">
    <h2>Tickets</h2>
    <a href="/admin/index.html">Back</a>
</div>
<hr>
<p>
    Tickets can be registered to provide service tier subscriptions.
    <br>
    (Only Baksa can register tickets.)
</p>
<p>
    Group numbers are used to categorize service tiers:
    <br>
<ul>
    <li>1: Trial</li>
    <li>2: Standard</li>
    <li>3: Premium</li>
    <li>50: Unlimited</li>
    <li>51: Free Standard</li>
</ul>
</p>

<br>

<h2>Register Tickets</h2>
<hr>
<form onsubmit="registerTicket(event)">
    <table id="reg_form">
        <style>
            #reg_form {
                text-align: left;
                width: 100%;
            }

            #reg_form tr td:first-child {
                padding: 4px;
                width: 186px;
            }

            #reg_form tr td input:not([type="submit"]) {
                width: 100%;
            }
        </style>
        <tr>
            <td>
                Ticket ID&nbsp;
            </td>
            <td>
                <input type="text" id="ticket_id" placeholder="Ticket ID">
            </td>
        </tr>
        <tr>
            <td>
                Description&nbsp;
            </td>
            <td>
                <input type="text" id="desc" placeholder="Description">
            </td>
        </tr>
        <tr>
            <td>
                Service Group&nbsp;
            </td>
            <td>
                <input type="number" id="group" placeholder="Group Number">
            </td>
        </tr>
        <tr>
            <td>
                Stripe Client Secret&nbsp;
            </td>
            <td>
                <input type="text" id="secret" placeholder="Client Secret">
            </td>
        </tr>
        <tr>
            <td></td>
            <td style="float:right;">
                <input type="submit" value="Register">
            </td>
        </tr>
    </table>
</form>

<br>

<h2>Registered Tickets</h2>
<hr>
<div id="list_wrap">
    <style>
        #list_wrap {
            overflow-x: auto;
            white-space: nowrap;
        }

        .tickets {
            text-align: left;
        }

        .tickets td {
            padding: 4px;
        }

        .tickets tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.05);
        }
    </style>
    <table class='tickets' id="registered_tickets">
        <tr>
            <th>-</th>
            <th>-</th>
            <th>Ticket ID</th>
            <th>Description</th>
            <th>Service Group</th>
            <th>Request Authorization</th>
            <style>
                th {
                    font-weight: bold;
                    padding: 4px;
                }
            </style>
        </tr>
    </table>
</div>
<br>

<h2>Consumed Tickets</h2>
<hr>
<div id="list_wrap">
    <style>
        #list_wrap {
            overflow-x: auto;
            white-space: nowrap;
        }

        th {
            font-weight: bold;
            padding: 4px;
        }
    </style>
    <table class='tickets' id="consumed_tickets">
        <tr>
            <th>Time</th>
            <th>User</th>
            <th>Service</th>
            <th>Subscription</th>
        </tr>
    </table>
</div>
<br>
<br>
<script>
    skapi.getProfile().then(u => console.log(u));

    skapi.getTickets({
        service: 'eu71zettahertzesskpi'
    }).then(tickets => {
        console.log(tickets);
        for (let t of tickets.list) {
            let service_group = t.action.update_service.group;
            let request_authorization = t.condition.request.headers.Authorization;
            let description = t.desc;
            let timestamp = t.stmp;
            let ticket_id = t.ticket_id;
            let row = /*html*/`
                <td><button onclick="delete_ticket('${ticket_id}')">Delete</button></td>
                <td><button onclick="list_consumed('${ticket_id}')">Consumed</button></td>
                <td>${ticket_id}</td>
                <td>${description}</td>
                <td>${service_group}</td>
                <td>${request_authorization}</td>`;
            let tr = document.createElement('tr');
            tr.id = ticket_id;
            tr.innerHTML = row;
            registered_tickets.appendChild(tr);
        }
    });

    function delete_ticket(ticket_id) {
        document.getElementById(ticket_id).remove();
        skapi.unregisterTicket({
            service: 'eu71zettahertzesskpi',
            ticket_id
        }).then(res => console.log(res));
    }

    let currentConsumeDisplay = '';
    function list_consumed(ticket_id) {
        if (currentConsumeDisplay !== ticket_id) {
            consumed_tickets.innerHTML = /*html*/`
                <tr>
                    <th>Time</th>
                    <th>User</th>
                    <th>Service</th>
                    <th>Subscription</th>
                </tr>`;
            currentConsumeDisplay = ticket_id;
        }

        skapi.getTickets({
            service: 'eu71zettahertzesskpi',
            ticket_id: '#' + ticket_id + '#'
        }).then(tickets => {
            console.log(tickets);
            currentConsumeDisplay = ticket_id;
            for (let t of tickets.list) {
                let user_id = t.user_id;
                let timestamp = t.stmp;
                let subscription_id = t.placeholder.SUBSCRIPTION_ID;
                let service_id = t.placeholder.SERVICE_ID;

                let row = /*html*/`
                    <td>${Date(timestamp).toLocaleString().split(' GMT')[0]}</td>
                    <td>${user_id}</td>
                    <td>${service_id}</td>
                    <td>${subscription_id}</td>
                    `;
                let tr = document.createElement('tr');
                tr.innerHTML = row;
                consumed_tickets.appendChild(tr);
            }
        });
    }

    function registerTicket(event) {
        event.preventDefault();
        const desc = document.getElementById('desc').value;
        const group = document.getElementById('group').value;

        let product = {
            standard: 'price_1OUCt6HfHjKTnB39IwJasJEy',
            premium: 'price_1OeZSqHfHjKTnB395Ai9fY4m'
        }

        let tid = document.getElementById('ticket_id').value;
        let srvc_grp = parseInt(group); // 0 is delete

        let match = [
            {
                target_key: 'metadata.service',
                operator: '=',
                value: '$SERVICE_ID'
            }
        ];

        let request = {
            url: 'https://api.stripe.com/v1/subscriptions/$SUBSCRIPTION_ID',
            method: srvc_grp ? 'GET' : 'DELETE',
            headers: {
                Authorization: `Bearer ${document.getElementById('secret').value}`
            },
            match
        };

        if (product[tid]) {
            request.match.push({
                target_key: 'plan.id',
                operator: '=',
                value: product[tid]
            });
        }
        else if (!srvc_grp) {
            request.params = {
                prorate: true
            }
        }

        skapi.registerTicket({
            service: 'eu71zettahertzesskpi',
            ticket_id: tid,
            condition: {request},
            action: {
                update_service: {group: srvc_grp, action: 1}
            },
            desc
        }).then(res => {
            console.log(res);
        }).catch(err => {
            alert(err.message);
        });
    }
</script>
<style>
    body {
        display: block;
        max-width: 1200px;
        margin: auto;
        padding: 8px;
        box-sizing: border-box;
    }
</style>